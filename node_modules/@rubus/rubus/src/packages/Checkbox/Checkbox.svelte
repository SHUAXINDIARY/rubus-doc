<script>
  import { IconCheckmarkSmall, IconDashSmall } from "@rubus/svelte-spectrum-icons-ui";
  import ResizeObserver from "resize-observer-polyfill";
  import { throttle } from "throttle-debounce";
  import { afterUpdate, onDestroy } from "svelte";
  import { current_component } from "svelte/internal";
  import { getEventsAction } from "../utils/get-events-action.js";

  /**
   * Specify whether the checkbox is checked
   * @type {boolean} [checked=false]
   */
  export let checked = false;

  /**
   * Set to `true` to disable the checkbox
   * @type {boolean} [disabled=false]
   */
  export let disabled = false;

  /**
   * Whether the input should display its "valid" or "invalid" visual styling.
   * @type {boolean} [isInvalid=false]
   */
  export let isInvalid = false;

  /**
   * This prop sets the quiet style which provides visual weaken.
   * @type {boolean} [isQuiet=false]
   */
  export let isQuiet = false;

  /**
   * Specify whether the checkbox is indeterminate
   * @type {boolean} [indeterminate=false]
   */
  export let indeterminate = false;

  /**
   * Set to `true` for the checkbox to be read-only
   * @type {boolean} [readonly=false]
   */
  export let readonly = false;

  /**
   * Set a name for the input element
   * @type {string} [name=""]
   */
  export let name = "";

  /**
   * Set an id for the input element
   * @type {string} [id = "checkbox-" + Math.random().toString(24)]
   */
  export let id = "checkbox-" + Math.random().toString(24);

  /**
   * Set an id for the input element
   * @type {string} [value = ""]
   */
  export let value = "";

  /**
   * Set an title for the input labal
   * @type {string} [title = ""]
   */
  export let title = "";

  let checkbox;
  let iconSize = 10;
  let large = false;
  const eventsListen = getEventsAction(current_component);
  const observer = new ResizeObserver(getIconScale);

  afterUpdate(() => {
    throttle(500, observer.observe(checkbox));
  });

  onDestroy(() => {
    observer.unobserve(checkbox);
  });

  function getIconScale() {
    iconSize = parseInt(
      getComputedStyle(document.documentElement).getPropertyValue("--spectrum-global-dimension-size-125")
    );
    if (iconSize == 10) {
      large = false;
    } else {
      large = true;
    }
  }
</script>

<style global>
  .readonly {
    pointer-events: none;
  }
</style>

{#if readonly}
  <label
    {title}
    {...$$restProps}
    class="spectrum-Checkbox readonly {$$restProps.class}"
    class:is-disabled={disabled}
    class:is-indeterminate={indeterminate}
    class:is-invalid={isInvalid}
    class:spectrum-Checkbox--quiet={isQuiet}>
    <input
      type="checkbox"
      class="spectrum-Checkbox-input"
      {id}
      {name}
      {disabled}
      {value}
      bind:this={checkbox}
      {checked}
      {indeterminate} />
    <span class="spectrum-Checkbox-box">
      {#if checked}
        <IconCheckmarkSmall
          width={iconSize - 1}
          height={iconSize - 1}
          scale={large ? 'L' : 'M'}
          className="spectrum-Checkbox-checkmark"
          focusable="false"
          aria-hidden="true" />
      {/if}
      {#if indeterminate}
        <IconDashSmall
          width={iconSize}
          height={iconSize}
          scale={large ? 'L' : 'M'}
          className="spectrum-Checkbox-partialCheckmark"
          focusable="false"
          aria-hidden="true" />
      {/if}
    </span>
    <span class="spectrum-Checkbox-label">
      <slot>Checkbox</slot>
    </span>
  </label>
{:else}
  <label
    {...$$restProps}
    class="spectrum-Checkbox {$$restProps.class}"
    class:is-disabled={disabled}
    class:is-indeterminate={indeterminate}
    class:is-invalid={isInvalid}
    class:spectrum-Checkbox--quiet={isQuiet}
    use:eventsListen>
    <input
      type="checkbox"
      class="spectrum-Checkbox-input"
      {id}
      {name}
      {disabled}
      {value}
      bind:this={checkbox}
      bind:checked
      bind:indeterminate />
    <span class="spectrum-Checkbox-box">
      {#if checked}
        <IconCheckmarkSmall
          width={iconSize - 1}
          height={iconSize - 1}
          scale={large ? 'L' : 'M'}
          className="spectrum-Checkbox-checkmark"
          focusable="false"
          aria-hidden="true" />
      {/if}
      {#if indeterminate}
        <IconDashSmall
          width={iconSize}
          height={iconSize}
          scale={large ? 'L' : 'M'}
          className="spectrum-Checkbox-partialCheckmark"
          focusable="false"
          aria-hidden="true" />
      {/if}
    </span>
    <span class="spectrum-Checkbox-label">
      <slot />
    </span>
  </label>
{/if}
