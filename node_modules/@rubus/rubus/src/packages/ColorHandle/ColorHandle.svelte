<script>
  import { onMount } from "svelte";
  import Color from "../utils/color/color.js";
  import ColorLoupe from "../ColorLoupe";
  export let px = 0;
  export let py = 0;

  export let color = "#000";

  /**
   * Set to `true` to disable the color loupe
   * @type {boolean}[disabled=false]
   */
  export let disabled = false;

  /**
   * Set its color loupe pop-up orientation
   * @type {"horizontal" | "vertical" }[orientation = "horizontal"]
   */
  export let orientation = "horizontal";

  /**
   * Preconditions: variants => "alpha"
   * Get current opacity
   * @type {number}  [alpha = 1ã€‘
   */
  export let alpha = 1;

  let isOpen = false;
  let colorHandle;

  $: thisBackgroundColor = Color(color).rgb().object();
  onMount(() => {
    if (!disabled) {
      colorHandle &&
        colorHandle.parentElement &&
        colorHandle.parentElement.addEventListener("mouseup", function (e) {
          isOpen = false;
        });
      colorHandle &&
        colorHandle.parentElement &&
        colorHandle.parentElement.addEventListener("mousedown", function (e) {
          isOpen = true;
        });
      window && window.addEventListener("click", listenForOtherClicks);
      window && window.addEventListener("keyup", listenForOtherClicks);
    }
  });

  function listenForOtherClicks(e) {
    if (colorHandle && colorHandle.parentElement && !colorHandle.parentElement.contains(e.target)) {
      isOpen = false;
    }
  }
</script>

<div
  bind:this={colorHandle}
  class="spectrum-ColorHandle {$$restProps.class}"
  class:is-disabled={disabled}
  style="position: absolute; top: {py}%; left: {px}%;">
  <div
    class="spectrum-ColorHandle-color"
    style="background-color: rgba({thisBackgroundColor.r},{thisBackgroundColor.g},{thisBackgroundColor.b},{alpha});" />
  <ColorLoupe {color} {isOpen} {orientation} {alpha} />
</div>
