<script>
  import { IconChevronRightMedium, IconChevronDownMedium } from "@rubus/svelte-spectrum-icons-ui";
  import ResizeObserver from "resize-observer-polyfill";
  import { throttle } from "throttle-debounce";
  import { afterUpdate, onDestroy } from "svelte";
  import { current_component } from "svelte/internal";
  import { getEventsAction } from "../utils/get-events-action.js";

  //TODO:Large 尺寸下 header 里文字和ICON会对不齐

  /**
   * Specify the unique index for the accordion item
   * @type {number} [tselfIndex = 0]
   */
  export let selfIndex = 0;

  /**
   * Set to `true` to disable the accordion item
   * @type {boolean} [disabled=false]
   */
  export let disabled = false;

  /**
   * Set accordion item open state
   * @type {boolean} [isOpen=false]
   */
  export let isOpen = false;

  const eventsListen = getEventsAction(current_component);
  const observer = new ResizeObserver(getIconScale);
  let accordionItem;
  afterUpdate(() => {
    throttle(500, observer.observe(accordionItem));
  });

  onDestroy(() => {
    observer.unobserve(accordionItem);
  });

  let iconWidth;
  let iconHeight;
  let large = false;

  function getIconScale() {
    iconWidth = parseInt(
      getComputedStyle(document.documentElement).getPropertyValue("--spectrum-global-dimension-size-75")
    );
    iconHeight = parseInt(
      getComputedStyle(document.documentElement).getPropertyValue("--spectrum-global-dimension-size-125")
    );
    if (iconWidth == 6) {
      large = false;
    } else {
      large = true;
    }
  }

  function switchStatus(event) {
    let heading = event.target.closest(".spectrum-Accordion-itemHeading");
    if (heading) {
      let item = event.target.closest(".spectrum-Accordion-item");
      let isDisabled = item.classList.contains("is-disabled");
      if (!isDisabled) {
        item.classList.toggle("is-open");
        event.preventDefault();
      }
    }
  }
</script>

<div
  {...$$restProps}
  class="spectrum-Accordion-item"
  class:is-disabled={disabled}
  role="presentation"
  class:is-open={isOpen}
  bind:this={accordionItem}
  use:eventsListen>
  <h3 class="spectrum-Accordion-itemHeading" on:click={switchStatus}>
    <button
      class="spectrum-Accordion-itemHeader"
      type="button"
      id="spectrum-accordion-item-{selfIndex}-header"
      aria-controls="spectrum-accordion-item-{selfIndex}-content"
      aria-expanded="true">
      <slot />
    </button>

    <IconChevronRightMedium
      width={isOpen && iconWidth}
      height={isOpen && iconHeight}
      scale={large ? 'L' : 'M'}
      focusable="false"
      aria-hidden="true"
      className="spectrum-Accordion-itemIndicator" />
  </h3>
  <div
    class="spectrum-Accordion-itemContent"
    role="region"
    id="spectrum-accordion-item-{selfIndex}-content"
    aria-labelledby="spectrum-accordion-item-{selfIndex}-header">
    <slot name="accordion-item-content" />
  </div>
</div>
