<script>
  import { afterUpdate, onMount } from "svelte";
  import { getRect, getInTheBoxPosition } from "../utils/element.js";

  /**
   * Specify the role of menu
   * @type {string} [role = "menu"]
   */
  export let role = "menu";

  /**
   * Specify the max-width of menu
   * @type {number} [maxWidth = 0]
   */
  export let maxWidth = 0;

  /**
   * Specify the min-width of menu
   * @type {number} [minWidth = 0]
   */
  export let minWidth = 0;

  /**
   * Specify the aria-labelledby of menu
   * @type {string} [ariaLabelledby = ""]
   */
  export let ariaLabelledby = "";

  /**
   * Specify the nested mode of menu
   * @type {boolean} [nested = false]
   */
  export let nested = false;

  let menuEl;
  let menuWidth;
  afterUpdate(() => {
    if (menuEl) {
      nested && resetPosition();
      menuWidth = setWidth().width;
    }
  });
  onMount(() => {
    nested && window.addEventListener("click", listenForChildClicks);
  });

  function listenForChildClicks(e) {
    let prevNode = menuEl.previousElementSibling;
    if (prevNode && prevNode.contains(e.target)) {
      menuEl.previousElementSibling && resetPosition();
    }
  }

  let getInTheBoxPositionTop = 0;
  let getInTheBoxPositionLeft = 0;
  function resetPosition() {
    let prevNode = menuEl.previousElementSibling;
    if (prevNode) {
      let openItem = prevNode.querySelector(".spectrum-Menu-item.is-open");
      getInTheBoxPositionLeft = getRect(prevNode).width;
      [, getInTheBoxPositionTop] = getInTheBoxPosition(prevNode, openItem);
    }
  }
  function setWidth() {
    let thisMenu = menuEl.parentElement.parentElement.querySelector("#rubus-ActionSource");
    if (thisMenu) {
      return getRect(thisMenu);
    } else {
      return { width: 0 };
    }
  }

  $: styleCssText = [
    maxWidth ? `max-width:${maxWidth}px;` : `max-width:${menuWidth}px;`,
    minWidth ? `min-width:${minWidth}px;` : `min-width:${menuWidth}px;`,
    nested && `top:${getInTheBoxPositionTop}px;`,
    nested && `left:${getInTheBoxPositionLeft}px;`,
  ]
    .filter(Boolean)
    .join(" ");
</script>

<style global>
  .spectrum-Menu-itemLabel {
    white-space: nowrap;
    width: auto;
    display: inline-block;
    *display: inline;
  }
  .spectrum-Menu {
    overflow-x: hidden;
  }
  .spectrum-Menu-nested {
    position: absolute;
  }
</style>

<ul
  class="spectrum-Menu"
  class:spectrum-Menu-nested={nested}
  {role}
  style={styleCssText}
  bind:this={menuEl}
  aria-labelledby={ariaLabelledby}>
  <slot />
</ul>
