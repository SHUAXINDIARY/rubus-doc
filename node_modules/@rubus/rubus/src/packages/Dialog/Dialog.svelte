<script>
  import { afterUpdate, onMount } from "svelte";
  import { IconCrossLarge, IconAlertMedium } from "@rubus/svelte-spectrum-icons-ui";
  import Button from "../Button";
  import Image from "../Asset/Image.svelte";
  import { advanceAddClassName } from "../utils/presetStyle.js";

  /**
   * Specify the variant of dialog
   * @type {"small" | "medium" | "large" | "alert" | "fullscreen" | "fullscreenTakeover" } [variants = ""]
   */
  export let variants = "";

  /**
   * Specify the css `z-index` of dialog
   * @type {number} [zIndex = 100]
   */
  export let zIndex = 100;

  /**
   * Specify the title of dialog
   * @type {string} [title = ""]
   */
  export let title = "";

  /**
   * Set the src attribute of the hero image
   * @type {string} [imgUrl = ""]
   */
  export let heroImgUrl = "";

  /**
   * Set the alt attribute of the hero image
   * @type {string} [imgAlt = "Hero image"]
   */
  export let heroImgAlt = "Hero image";

  /**
   * Whether to keep the dismissible option
   * @type {boolean} [dismissible = false]
   */
  export let dismissible = false;

  /**
   * Set dialog to an error status
   * Preconditions: variants =>  "alert"
   * @type {boolean} [isError = false]
   */
  export let isError = false;

  /**
   * Whether to keep the divider
   * @type {boolean} [noDivider = false]
   */
  export let noDivider = false;

  /**
   * Whether to keep the open status
   * @type {boolean} [isOpen = false]
   */
  export let isOpen = false;

  /**
   * Whether to allow clicking on the Underlay area to close the dialog
   * @type {boolean} [puncture = false]
   */
  export let puncture = false;

  let dialogEl;
  let large = false;
  let iconSize = 12;
  function getIconScale() {
    iconSize = parseInt(
      getComputedStyle(document.documentElement).getPropertyValue("--spectrum-global-dimension-size-150")
    );
    if (iconSize == 12) {
      large = false;
    } else {
      large = true;
    }
  }

  onMount(() => {
    advanceAddClassName(dialogEl, "dialog-footer", "spectrum-Dialog-footer");
  });
  afterUpdate(() => {
    getIconScale();
  });

  function cancelDialog() {
    isOpen = false;
  }
</script>

<style global>
  .spectrum-Underlay {
    background: var(--spectrum-dialog-underlay-background-color, var(--spectrum-alias-background-color-modal-overlay));
  }
  .spectrum-Underlay {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    overflow: hidden;
    transition: opacity
        var(--spectrum-dialog-background-exit-animation-duration, var(--spectrum-global-animation-duration-300))
        cubic-bezier(0.5, 0, 1, 1)
        var(--spectrum-dialog-background-exit-animation-delay, var(--spectrum-global-animation-duration-200)),
      visibility 0ms linear
        calc(
          var(--spectrum-dialog-background-exit-animation-delay, var(--spectrum-global-animation-duration-200)) +
            var(--spectrum-dialog-background-exit-animation-duration, var(--spectrum-global-animation-duration-300))
        );
  }
  .spectrum-Underlay {
    visibility: hidden;
    opacity: 0;
    transition: transform var(--spectrum-global-animation-duration-100, 130ms) ease-in-out,
      opacity var(--spectrum-global-animation-duration-100, 130ms) ease-in-out,
      visibility 0ms linear var(--spectrum-global-animation-duration-100, 130ms);
    pointer-events: none;
  }
  .spectrum-Underlay.is-open {
    transition: opacity
      var(--spectrum-dialog-background-entry-animation-duration, var(--spectrum-global-animation-duration-600))
      cubic-bezier(0, 0, 0.4, 1) 0ms;
  }
  .spectrum-Underlay.is-open {
    visibility: visible;
    opacity: 1;
    transition-delay: 0ms;
    pointer-events: auto;
  }

  [dir="ltr"].spectrum--large .spectrum-Dialog-closeButton {
    right: 0;
  }

  [dir="rtl"].spectrum--large .spectrum-Dialog-closeButton {
    left: 0;
  }

  .spectrum--large .spectrum-Dialog-closeButton {
    position: absolute;
    top: calc(-1 * var(--spectrum-global-dimension-size-75));
  }
</style>

<div class="spectrum-Underlay" class:is-open={isOpen} style="z-index:{zIndex}" on:click={puncture && cancelDialog} />

<div class="spectrum-Dialog-wrapper" style="z-index:{+zIndex + 1}">
  <div
    class="spectrum-Dialog {variants ? `spectrum-Dialog--${variants}` : ''}"
    class:spectrum-Dialog--dismissible={dismissible}
    class:spectrum-Dialog--error={isError && variants == 'alert'}
    class:spectrum-Dialog--noDivider={noDivider}
    class:is-open={isOpen}
    bind:this={dialogEl}>
    {#if heroImgUrl}
      <Image imgUrl={heroImgUrl} imgAlt={heroImgAlt} class="spectrum-Dialog-hero" />
    {/if}
    <div class="spectrum-Dialog-header">
      <h2 class="spectrum-Dialog-title">{title}</h2>
      <slot name="dialog-header" />
      {#if isError && variants == 'alert'}
        <IconAlertMedium className="spectrum-Dialog-typeIcon" />
      {/if}
      <Button class="spectrum-Dialog-closeButton" exterior="action" isQuiet on:click={cancelDialog}>
        <div slot="button-icon">
          <IconCrossLarge scale={large ? 'L' : 'M'} width={iconSize} height={iconSize} />
        </div>
      </Button>
    </div>

    <div class="spectrum-Dialog-content">
      <slot />
    </div>
    <slot name="dialog-footer" />
  </div>
</div>
