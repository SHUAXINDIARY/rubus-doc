<script>
  import { onMount, afterUpdate } from "svelte";

  /**
   * The element's unique identifier.
   * @type { number }[id = Math.round(Math.random() * (99 - 0)) + 0]
   */
  export let id = Math.round(Math.random() * (99 - 0)) + 0;

  /**
   * Specify the label text  for the  slider
   * @type { string }[ label = ""]
   */
  export let label = "";

  /**
   * The value of the slider
   * @type { number }[value = 0]
   */
  export let value = 0;

  /**
   * Specify the range value for the  slider
   * @type { Array }[rangeValue = []]
   */
  export let rangeValue = [];

  /**
   * Set to `true` to disable the slider
   * @type {boolean}[disabled=false]
   */
  export let disabled = false;

  /**
   * Specify the variants  for the  slider
   * @type {"basic" | "filled" | "filled-offset" | "range" | "tick" | "tick-with-label" | "ramp"}[variants = "basic"]
   */
  export let variants = "basic";

  /**
   * Preconditions: variants => "tick" or "tick-with-label"
   * Specify the tick total for the  slider
   * @type { number }[tickTotal = 5]
   */
  export let tickTotal = 5;

  /**
   * Preconditions: variants => "tick" or "tick-with-label"
   * Whether to limit its value to proportional value
   * @type { boolean }[tickRestrict = false]
   */
  export let tickRestrict = false;

  /**
   * Specify the max value for the  slider
   * @type { number }[maxValue = 100]
   */
  export let maxValue = 100;

  /**
   * Specify the min value for the  slider
   * @type { number }[maxValue = 0]
   */
  export let minValue = 0;

  let sliderHandleAmount = 50;
  let orientation = "horizontal";

  let isMain = false;
  let isAnother = false;
  function handleSliderAction(e) {
    if (disabled) {
      return;
    }
    isMain = e.target.classList.contains("spectrum-Slider-handle-main");
    isAnother = e.target.classList.contains("spectrum-Slider-handle-another");
    getSliderPosition(e);
    window.addEventListener("mousemove", getSliderPosition);
    window.addEventListener("mouseup", removeGetSliderPositionEvent);
  }

  let expendAmount = 50;
  let remainderAmount = 50;
  let sliderFillWidth = 0;
  let expendAmountAnother = 100;
  let sliderHandleAmountAnother = 100;

  let posValue = 50;
  let posAnotherValue = 50;

  function getSliderPosition(e) {
    e.preventDefault();
    document.body.classList.add("u-isGrabbing");

    const thisRect = sliderEl.getBoundingClientRect();
    let _pageP = orientation === "horizontal" ? e.pageX : e.pageY;
    let _orientation = orientation === "horizontal" ? thisRect.left : thisRect.top;
    let _crisscross = orientation === "horizontal" ? thisRect.width : thisRect.height;

    let _p = _pageP - _orientation;
    if (_p > _crisscross) {
      _p = _crisscross;
    }
    if (_p < 0) {
      _p = 0;
    }

    if (
      variants === "basic" ||
      variants === "filled" ||
      variants === "tick" ||
      variants === "tick-with-label" ||
      variants === "ramp"
    ) {
      orientation === "horizontal"
        ? (sliderHandleAmount = (_p / _crisscross) * maxValue) && (posValue = (_p / _crisscross) * maxValue)
        : (sliderHandleAmount = (_p / _crisscross) * maxValue);
      value = parseInt(posValue, 10);
    }
    if (variants === "filled-offset") {
      orientation === "horizontal"
        ? (sliderHandleAmount = (_p / _crisscross) * maxValue) && (posValue = (_p / _crisscross) * maxValue)
        : (sliderHandleAmount = (_p / _crisscross) * maxValue);
      if (posValue < maxValue / 2) {
        if (posValue === minValue) {
          value = -1 * (maxValue / 2);
        } else {
          value = -1 * (maxValue / 2) + posValue;
        }
      }
      if (posValue > maxValue / 2) {
        if (posValue >= maxValue) {
          value = posValue - maxValue / 2 - 1;
        } else {
          value = posValue - maxValue / 2;
        }
      }
      value = parseInt(value, 10);
    }
    if (variants === "range") {
      let stintValue = (_p / _crisscross) * maxValue;
      if (orientation === "horizontal") {
        if (isMain) {
          sliderHandleAmount = (_p / _crisscross) * maxValue;
          posValue = (_p / _crisscross) * maxValue;
          rangeValue[0] = parseInt(posValue, 10);
          if (rangeValue[0] >= rangeValue[1]) {
            rangeValue[0] = rangeValue[1] - 1;
          }
        } else if (isAnother) {
          sliderHandleAmountAnother = (_p / _crisscross) * maxValue;
          posAnotherValue = (_p / _crisscross) * maxValue;
          rangeValue[1] = parseInt(posAnotherValue, 10);
          if (rangeValue[1] <= rangeValue[0]) {
            rangeValue[1] = rangeValue[0] + 1;
          }
        } else {
          if (stintValue < posValue) {
            sliderHandleAmount = (_p / _crisscross) * maxValue;
            posValue = (_p / _crisscross) * maxValue;
            rangeValue[0] = parseInt(posValue, 10);
            if (rangeValue[0] >= rangeValue[1]) {
              rangeValue[0] = rangeValue[1] - 1;
            }
          } else if (stintValue !== posValue) {
            sliderHandleAmountAnother = (_p / _crisscross) * maxValue;
            posAnotherValue = (_p / _crisscross) * maxValue;
            rangeValue[1] = parseInt(posAnotherValue, 10);
            if (rangeValue[1] <= rangeValue[0]) {
              rangeValue[1] = rangeValue[0] + 1;
            }
          }
        }
      }
    }
  }

  function removeGetSliderPositionEvent(e) {
    document.body.classList.remove("u-isGrabbing");

    window.removeEventListener("mousemove", getSliderPosition);
    isMain = false;
    isAnother = false;
    if ((variants === "tick" || variants === "tick-with-label") && tickRestrict) {
      let fl = value;
      let times = 0;
      let times2 = 0;
      let thisTickIndex = 0;
      let thisTickIndex2 = 0;
      for (let index = 0; index < ticks[1]; index++) {
        if (ticks.indexOf(fl + index) !== -1) {
          times = index;
          thisTickIndex = ticks.indexOf(fl + index);
        }
      }
      for (let index = 0; index < ticks[1]; index++) {
        if (ticks.indexOf(fl - index) !== -1) {
          times2 = index;
          thisTickIndex2 = ticks.indexOf(fl + index);
        }
      }
      if (times > times2) {
        value = ticks[thisTickIndex - 1];
      } else {
        value = ticks[thisTickIndex];
      }
      rangeValue = [ticks[thisTickIndex - 1], ticks[thisTickIndex]];
    }
  }

  function getTrackRect() {
    if (
      variants === "basic" ||
      variants === "filled" ||
      variants === "tick" ||
      variants === "tick-with-label" ||
      variants === "ramp"
    ) {
      expendAmount = value;
      sliderHandleAmount = value;
      remainderAmount = maxValue - expendAmount;
    }
    if (variants === "basic" || variants === "filled" || variants === "ramp") {
      rangeValue = [minValue, maxValue];
    }
    if (variants === "filled-offset") {
      if (value < 0) {
        posValue = maxValue / 2 - Math.abs(value);
      }
      if (value > 0) {
        posValue = maxValue / 2 + value;
      }
      expendAmount = posValue;
      sliderHandleAmount = posValue;
      remainderAmount = maxValue - expendAmount;

      sliderFillWidth = Math.abs(posValue - maxValue / 2);
      rangeValue = [expendAmount, remainderAmount];
    }
    if (variants === "range") {
      expendAmount = rangeValue[0];
      sliderHandleAmount = rangeValue[0];

      expendAmountAnother = Math.abs(100 - rangeValue[1] - (100 - expendAmount));
      sliderHandleAmountAnother = rangeValue[1];

      remainderAmount = 100 - sliderHandleAmountAnother;
    }
  }

  let sliderEl;
  let sliderHandleEl;
  let sliderHandleAnotherEl;
  let ticks = [];
  onMount(() => {
    sliderEl.addEventListener("mousedown", function (e) {
      handleSliderAction(e);
    });
    if (variants === "filled-offset") {
      maxValue += (maxValue - minValue) * 0.02;
    }
    if (variants === "range") {
      if (!rangeValue.length) {
        rangeValue = [minValue, maxValue];
      }
    }
    if (variants === "tick" || variants === "tick-with-label") {
      ticks.length = tickTotal;
      for (let index = 0; index < tickTotal + 1; index++) {
        ticks[index] = parseInt(((maxValue - minValue) / tickTotal) * index, 10);
      }
      if (!rangeValue.length) {
        rangeValue = [minValue, maxValue];
      }
    }
  });

  afterUpdate(() => {
    getTrackRect();
  });
</script>

<div
  class="spectrum-Slider"
  class:spectrum-Slider--filled={variants === 'filled'}
  class:spectrum-Slider--range={variants === 'range'}
  class:spectrum-Slider--tick={variants === 'tick'}
  class:spectrum-Slider--ramp={variants === 'ramp'}
  class:is-disabled={disabled}
  aria-labelledby="spectrum-Slider-label-{id}"
  role="group"
  bind:this={sliderEl}
  style="width:400px">
  {#if label}
    <div class="spectrum-Slider-labelContainer">
      <label
        class="spectrum-Slider-label"
        id="spectrum-Slider-label-{id}"
        for="spectrum-Slider-input-{id}">{label}</label>
      <div
        class="spectrum-Slider-value"
        role="textbox"
        aria-readonly="true"
        aria-labelledby="spectrum-Slider-label-{id}">
        {variants === 'range' ? rangeValue[0] + '-' + rangeValue[1] : value}
      </div>
    </div>
  {/if}
  <div class="spectrum-Slider-controls" role="presentation">
    <div class="spectrum-Slider-track" style="width:{expendAmount}%" />
    {#if variants === 'tick' || variants === 'tick-with-label'}
      <div class="spectrum-Slider-ticks">
        {#each ticks as tickItem}
          <div class="spectrum-Slider-tick">
            {#if variants === 'tick-with-label'}
              <div class="spectrum-Slider-tickLabel">{tickItem}</div>
            {/if}
          </div>
        {/each}
      </div>
    {/if}
    {#if variants === 'ramp'}
      <div class="spectrum-Slider-ramp">
        <svg viewBox="0 0 240 16" preserveAspectRatio="none" aria-hidden="true" focusable="false">
          <path d="M240,4v8c0,2.3-1.9,4.1-4.2,4L1,9C0.4,9,0,8.5,0,8c0-0.5,0.4-1,1-1l234.8-7C238.1-0.1,240,1.7,240,4z" />
        </svg>
      </div>
    {/if}
    <div
      class="spectrum-Slider-handle spectrum-Slider-handle-main"
      role="presentation"
      style="left: {sliderHandleAmount}%;"
      bind:this={sliderHandleEl}>
      <input
        type="range"
        class="spectrum-Slider-input"
        value={variants === 'range' ? rangeValue[0] : value}
        step="2"
        min={minValue}
        max={maxValue}
        id="spectrum-Slider-input-{id}"
        aria-labelledby="spectrum-Slider-label-8 spectrum-Slider-input-{id}" />
    </div>

    {#if variants === 'range'}
      <div class="spectrum-Slider-track 01" style={`left:${sliderHandleAmount}%;width:${expendAmountAnother}%;`} />
      <div
        class="spectrum-Slider-handle spectrum-Slider-handle-another"
        role="presentation"
        style="left: {sliderHandleAmountAnother}%;"
        bind:this={sliderHandleAnotherEl}>
        <input
          type="range"
          class="spectrum-Slider-input"
          value={rangeValue[1]}
          step="2"
          min={minValue}
          max={maxValue}
          id="spectrum-Slider-input-8-1"
          aria-labelledby="spectrum-Slider-label-{id} spectrum-Slider-input-{id}-1" />
      </div>
    {/if}
    <div class="spectrum-Slider-track" style="width:{remainderAmount}%;" />
    {#if variants === 'filled-offset'}
      <div
        class="spectrum-Slider-fill"
        class:spectrum-Slider-fill--right={value > 0}
        style="{value < 0 ? `left: ${maxValue / 2 - sliderFillWidth}%;` : `left: 50%;`} width: {sliderFillWidth}%" />
    {/if}
  </div>
</div>
