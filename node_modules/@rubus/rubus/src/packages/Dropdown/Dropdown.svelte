<script>
  import { onMount } from "svelte";
  import { IconChevronDownMedium, IconAlertMedium } from "@rubus/svelte-spectrum-icons-ui";
  import { Popover } from "../Popover";
  import { Menu } from "../Menu";

  /**
   * Specify the placeholder of dropdown
   * @type {string} [placeholder = ""]
   */
  export let placeholder = "";

  /**
   * Set to `true` to disable the dropdown
   * @type {boolean}[disabled=false]
   */
  export let disabled = false;

  /**
   * Set whether dropdown is open
   * @type {boolean}[isOpen=false]
   */
  export let isOpen = false;

  /**
   * Set its external result index
   * @type { number } [resultIndex = 0
   */
  export let resultIndex = 0;

  /**
   * Set its current index
   * @type { number } [thisIndex = 0
   */
  export let thisIndex = 0;

  /**
   * Specify the invalid mode of dropdown
   * @type { boolean } [isInvalid= false]
   */
  export let isInvalid = false;

  /**
   * Specify the quiet mode of dropdown
   * @type { boolean } [isQuiet= false]
   */
  export let isQuiet = false;

  /**
   * Specify the css `min-width` of dropdown and child menu
   * @type { number } [minWidth = "200"]
   */
  export let minWidth = 200;

  /**
   * Whether to automatically fold
   * @type {boolean}[autoFold=false]
   */

  export let autoFold = true;

  let isActive = false;
  function dropdownStatusCutover() {
    isActive = true;
    resultIndex = thisIndex;
    isOpen = !isOpen;
  }
  onMount(() => {
    dropmenuEl && dropmenuEl.addEventListener("click", listenForChildClicks);
    dropmenuEl && dropmenuEl.addEventListener("keyup", listenForChildClicks);
    window && window.addEventListener("click", listenForOtherClicks);
    window && window.addEventListener("keyup", listenForOtherClicks);
  });

  let dropmenuEl;
  let triggerNode = "";
  function listenForChildClicks(e) {
    if (dropmenuEl && dropmenuEl.contains(e.target)) {
      if (e.target.classList.length) {
        if (testHasClassName(e.target.classList, `spectrum-Menu-item`)) {
          triggerNode = getNodeHTML(e.target.childNodes);
        } else if (testHasClassName(e.target.classList, `spectrum-Menu-itemLabel`)) {
          triggerNode = getNodeHTML(e.target.parentNode.childNodes);
        } else if (testHasClassName(e.target.parentNode.classList, `spectrum-Menu-item`)) {
          triggerNode = getNodeHTML(e.target.parentNode.childNodes);
        }
      }
    }
  }
  function listenForOtherClicks(e) {
    if (!autoFold) {
      return;
    }
    if (dropmenuEl && !dropmenuEl.contains(e.target)) {
      isOpen = false;
    }
  }

  function testHasClassName(el, verifyString) {
    if (!el) {
      return false;
    }
    for (let index = 0; index < el.length; index++) {
      return el[index] === verifyString;
    }
  }
  function getNodeHTML(el) {
    if (!el.length) {
      return "";
    }
    let nodeHTML = "";
    for (let index = 0; index < el.length; index++) {
      if (!testHasClassName(el[index].classList, `spectrum-Menu-checkmark`)) {
        el[index].outerHTML ? (nodeHTML = nodeHTML + el[index].outerHTML) : nodeHTML;
      }
    }
    return nodeHTML.replace(/spectrum-Menu-itemLabel/g, "spectrum-Dropdown-label");
  }
</script>

<style global>
  .spectrum-FieldButton {
    display: flex;
  }
  .spectrum-Dropdown-trigger > .spectrum-Dropdown-icon {
    transition: transform var(--spectrum-global-animation-duration-100, 130ms) ease-in-out,
      opacity var(--spectrum-global-animation-duration-100, 130ms) ease-in-out,
      visibility 0ms linear var(--spectrum-global-animation-duration-100, 130ms);
  }
  .spectrum-Dropdown-trigger.is-selected > .spectrum-Dropdown-icon {
    transform: rotate(180deg);
  }
</style>

<div
  class="spectrum-Dropdown"
  class:is-open={isOpen}
  class:is-invalid={isInvalid}
  class:is-disabled={disabled}
  class:spectrum-Dropdown--quiet={isQuiet}
  on:click={!disabled && dropdownStatusCutover}
  bind:this={dropmenuEl}>
  <button
    class="spectrum-FieldButton spectrum-Dropdown-trigger"
    class:is-selected={isOpen}
    class:is-invalid={isInvalid}
    class:is-disabled={disabled}
    class:spectrum-FieldButton--quiet={isQuiet}
    aria-haspopup="listbox"
    id="rubus-ActionSource"
    style="min-width:{minWidth}px">
    {#if !triggerNode}
      <span class="spectrum-Dropdown-label" class:is-placeholder={!isActive && placeholder}>
        <slot name="dropdown-label">{placeholder}</slot>
      </span>
    {:else}
      {@html triggerNode}
    {/if}
    {#if isInvalid}
      <IconAlertMedium focusable="false" aria-hidden="true" aria-label="Folder" />
    {/if}
    <IconChevronDownMedium className="spectrum-Dropdown-icon" focusable="false" aria-hidden="true" />
  </button>

  <Popover class="spectrum-Dropdown-popover" {isOpen}>
    <Menu role="listbox" {minWidth}>
      <slot />
    </Menu>
  </Popover>
  <div />
</div>
