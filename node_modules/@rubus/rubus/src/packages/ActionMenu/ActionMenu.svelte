<script>
  import { IconCornerTriangle } from "@rubus/svelte-spectrum-icons-ui";
  import { ButtonIconWrap } from "../ButtonGroup";
  import Button from "../Button";
  import { Popover } from "../Popover";
  import { onMount } from "svelte";
  /**
   * Specify the action menu button label
   * @type {string}[menuLabel=""]
   */
  export let menuLabel = "";

  /**
   * The position of the popver when it pops up
   * When the value is `auto`, it will automatically pop up according to the position of the component
   * For example, `bottomRight` the first one is Y direction, the second one is X direction
   * The parameter with `center` in the character is only valid when `variants == "dialog"`
   * The parameter with `center` in the character is invalid when `variants == "menu"`
   * @type {"auto"  | "bottomRight" | "bottomLeft" | "topLeft" | "topRight" | "leftTop" | "leftBottom" | "rightTop" | "rightBottom" | "centerTop" | "centerBtoom" | "centerLeft" | "centerRight"} [popverPosition = "auto"]
   */
  export let popverPosition = "auto";

  /**
   * Specify the variant of action menu
   * @type {"menu"  | "dialog"} [variant="menu"]
   */
  export let variants = "menu";

  /**
   * Specify the quiet mode of action menu button
   * @type { boolean } [isQuiet= false]
   */
  export let isQuiet = false;

  /**
   * Specify the emphasized status of action menu button
   * @type { boolean } [emphasized= false]
   */
  export let emphasized = false;

  /**
   * Specify the tabindex
   * @type {string}[tabindex="0"]
   */
  export let tabindex = 0;

  /**
   * Set to `true` to disable the button
   * @type {boolean}[disabled=false]
   */
  export let disabled = false;

  /**
   * Whether the action menu is collapsed
   * @type {boolean}[isOpen=false]
   */

  export let isOpen = false;

  /**
   * Whether long press to educe
   * @type {boolean}[holdEduce=false]
   */

  export let holdEduce = false;

  /**
   * Whether to automatically fold
   * @type {boolean}[autoFold=false]
   */

  export let autoFold = true;

  /**
   * Preconditions: holdEduce => true
   * Long press time
   * @type {number}[educeDuration=1000]
   */

  export let educeDuration = 1000;

  let timer;
  let actionMenu;
  function showPopover() {
    if (holdEduce) {
      return;
    } else {
      isOpen = !isOpen;
    }
  }
  function showPopoverLongPress() {
    timer = setTimeout(() => {
      isOpen = !isOpen;
    }, educeDuration);
  }
  function hidePopoverLongPress() {
    clearTimeout(timer);
  }

  onMount(() => {
    window && window.addEventListener("click", listenForOtherClicks);
    window && window.addEventListener("keyup", listenForOtherClicks);
  });
  function listenForOtherClicks(e) {
    if (!autoFold) {
      return;
    }
    if (actionMenu && !actionMenu.contains(e.target)) {
      isOpen = false;
    }
  }
</script>

<style>
  :global(.rubus-action-menu) {
    position: relative;

    display: inline-block;
  }
</style>

<div class="rubus-action-menu" bind:this={actionMenu} {...$$restProps}>
  <Button
    exterior="action"
    on:click={showPopover}
    isSelected={isOpen}
    on:mousedown={showPopoverLongPress}
    on:mouseup={hidePopoverLongPress}
    id="rubus-ActionSource"
    {isQuiet}
    {emphasized}
    {tabindex}
    {disabled}>
    <ButtonIconWrap onlyIcon={menuLabel == '' ? true : false}>
      <slot />
      <div slot="button-wrap-label">{menuLabel}</div>
      <div slot="button-icon-hold">
        {#if holdEduce}
          <IconCornerTriangle />
        {/if}
      </div>
    </ButtonIconWrap>
  </Button>
  <Popover {isOpen} {popverPosition} {variants} {isQuiet} />
</div>
