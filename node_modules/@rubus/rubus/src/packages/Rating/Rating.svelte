<script>
  import { IconStarOutline, IconStar } from "@rubus/svelte-spectrum-icons-ui";
  import { beforeUpdate } from "svelte";

  /**
   * Set whether its input is read-only
   * @type {boolean}[readonly=false]
   */
  export let readonly = false;

  /**
   * Whether to emphasized the Rating
   * @type {boolean}[emphasized=false]
   */
  export let emphasized = false;

  /**
   * Whether to disabled the Rating
   * @type {boolean}[disabled=false]
   */
  export let disabled = false;

  /**
   * Whether to value the Rating
   * @type {number}}[value = 0]
   */
  export let value = 0;

  /**
   * Whether to max value the Rating
   * @type {number}}[maxValue = 5]
   */
  export let maxValue = 5;

  /**
   * Whether to min value the Rating
   * @type {number}}[minValue = 0]
   */
  export let minValue = 0;

  let startNum = [];
  let ratingEl;
  let ratingInputEl;

  beforeUpdate(() => {
    startNum.length = maxValue;
    for (let index = 0; index < startNum.length; index++) {
      startNum[index] = index + 1;
    }
  });

  function setFocus(focused) {
    if (disabled) {
      return;
    }
    ratingEl.classList[focused ? "add" : "remove"]("is-focused");
  }

  function handleKeydown(event) {
    if (event.preventDefaulted || readonly || disabled) {
      return;
    }

    switch (event.which) {
      case 38:
        value = value < maxValue ? value + 1 : maxValue;
        break;
      case 39:
        value = value < maxValue ? value + 1 : maxValue;
        break;
      case 40:
        value = value <= minValue + 1 ? minValue : value - 1;
        break;
      case 37:
        value = value <= minValue + 1 ? minValue : value - 1;
        break;
    }
  }
</script>

<div
  class="spectrum-Rating"
  class:spectrum-Rating--emphasized={emphasized}
  class:is-readOnly={readonly}
  class:is-disabled={disabled}
  bind:this={ratingEl}
  on:focusin={() => {
    setFocus(true);
  }}
  on:focusout={() => {
    setFocus(false);
  }}>
  <input
    class="spectrum-Rating-input"
    aria-label="Rating"
    type="range"
    min={minValue}
    max={maxValue}
    {value}
    {readonly}
    on:keydown={handleKeydown}
    bind:this={ratingInputEl} />
  {#each startNum as item}
    <span
      class="spectrum-Rating-icon"
      class:is-selected={item <= value}
      class:is-currentValue={item === value}
      on:click={() => {
        if (readonly) {
          return;
        }
        value = item;
      }}>
      <IconStar
        className="spectrum-UIIcon-StarOutline spectrum-Rating-starActive"
        focusable="false"
        aria-hidden="true" />
      <IconStarOutline
        className="spectrum-UIIcon-StarOutline spectrum-Rating-starInactive"
        focusable="false"
        aria-hidden="true" />
    </span>
  {/each}
</div>
