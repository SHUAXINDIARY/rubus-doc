<script>
  import { onMount } from "svelte";
  import { current_component } from "svelte/internal";
  import { getEventsAction } from "../utils/get-events-action.js";
  import { IconCheckmarkMedium, IconAlertMedium } from "@rubus/svelte-spectrum-icons-ui";

  /**
   * The element's unique identifier.
   * @type { string }[id = `textfield-${Math.round(Math.random() * (99999 - 0)) + 0}`]
   */
  export let id = `textfield-${Math.round(Math.random() * (99999 - 0)) + 0}`;

  /**
   * Temporary text that occupies the text input when it is empty.
   * @type { string }[placeholder = ""]
   */
  export let placeholder = "";

  /**
   * The name of the input element, used when submitting an HTML form.
   * @type { string }[name = "field"]
   */
  export let name = "field";

  /**
   * The name of the input element, used when submitting an HTML form.
   * @type { string }[name = "field"]
   */
  export let value = "";

  /**
   * Set to `true` to mark the field as required
   * @type {boolean} [required=false]
   */
  export let required = false;

  /**
   * Set to `true` to disable the input
   * @type {boolean} [disabled=false]
   */
  export let disabled = false;

  /**
   * Whether the textfield should be displayed with a quiet style.
   * @type {boolean} [isQuiet=false]
   */
  export let isQuiet = false;

  /**
   * Whether the input should display its "valid" visual styling.
   * @type {boolean} [isValid=false]
   */
  export let isValid = false;

  /**
   * Whether the input should display its "invalid" visual styling.
   * @type {boolean} [isInvalid=false]
   */
  export let isInvalid = false;

  /**
   * Whether the input should display its "focused" visual styling.
   * @type {boolean} [isFocused=false]
   */
  export let isFocused = false;

  /**
   * Whether the input should display its "keyboard focused" visual styling.
   * @type {boolean} [isFocused=false]
   */
  export let isKeyboardFocused = false;

  /**
   * The maximum number of characters supported by the input.
   * @type {number} [maxLength = 32]
   */
  export let maxLength = 32;

  /**
   * The minimum number of characters required by the input.
   * @type {number} [minLength = 0]
   */
  export let minLength = 0;

  /**
   * The minimum number of characters required by the input.
   * @type {number} [minLength = 0]
   */
  export let resetType = "text";

  const eventsListen = getEventsAction(current_component);
  let textfieldEl;
  let inputEl;
  onMount(() => {
    textfieldEl && addClassName();
    if (textfieldEl && textfieldEl.lastChild.type) {
      textfieldEl.lastChild.type = resetType;
    }
  });

  function setFocus(focused) {
    var focusClass = inputEl.classList.contains("focus-ring") ? "is-keyboardFocused" : "is-focused";
    if (focused) {
      textfieldEl.classList.add(focusClass);
    } else {
      textfieldEl.classList.remove("is-keyboardFocused");
      textfieldEl.classList.remove("is-focused");
    }
  }
  function addClassName() {
    let fieldIconList = textfieldEl.getElementsByClassName("spectrum-Icon");
    if (fieldIconList.length) {
      for (let index = 0; index < fieldIconList.length; index++) {
        let isUIIcon = fieldIconList[index].classList.contains("spectrum-Textfield-validationIcon");
        if (!isUIIcon) {
          fieldIconList[index].classList.toggle(`spectrum-Textfield-icon`);
        }
      }
    }
  }
</script>

<div
  on:focusin={() => {
    setFocus(true);
  }}
  on:focusout={() => {
    setFocus(false);
  }}
  bind:this={textfieldEl}
  class="spectrum-Textfield {$$restProps.class}"
  class:spectrum-Textfield--quiet={isQuiet}
  class:is-valid={isValid}
  class:is-invalid={isInvalid}
  class:is-focused={isFocused}
  class:is-keyboardFocused={isKeyboardFocused}
  class:is-disabled={disabled}>
  {#if isValid}
    <IconCheckmarkMedium className="spectrum-Textfield-validationIcon" focusable="false" aria-hidden="true" />
  {/if}
  {#if isInvalid}
    <IconAlertMedium className="spectrum-Textfield-validationIcon" focusable="false" aria-hidden="true" />
  {/if}
  <slot />
  <input
    {id}
    bind:this={inputEl}
    class="spectrum-Textfield-input {$$restProps.inputClass}"
    {placeholder}
    {name}
    bind:value
    {required}
    {disabled}
    autocomplete={$$restProps.autocomplete}
    min={$$restProps.min}
    max={$$restProps.max}
    step={$$restProps.step}
    maxlength={maxLength}
    minlength={minLength}
    use:eventsListen />
</div>
