<script>
  import { IconChevronDownSmall, IconChevronUpSmall } from "@rubus/svelte-spectrum-icons-ui";
  import NP from "number-precision";
  import TextField from "../TextField";
  /**
   * The Boolean readonly attribute, when present, makes
   * the element not mutable, meaning the user can not edit the control.
   * @type {boolean}[readonly=false]
   */
  export let readonly = false;

  /**
   * Whether to disabled the Stepper
   * @type {boolean}[disabled=false]
   */
  export let disabled = false;

  /**
   * Whether to invalid the Stepper
   * @type {boolean}[isInvalid=false]
   */
  export let isInvalid = false;

  /**
   * Specify the quiet mode of Stepper
   * @type { boolean } [isQuiet= false]
   */
  export let isQuiet = false;

  /**
   * Specify the value of Stepper
   * @type { number } [ value = 1]
   */
  export let value = 1;

  /**
   * Specify the min value of Stepper
   * @type { number } [ minValue = -5]
   */
  export let minValue = -5;

  /**
   * Specify the max value of Stepper
   * @type { number } [ maxValue = 5]
   */
  export let maxValue = 5;

  /**
   *The stepper increments or decrements each time
   * @type { number } [ stepValue = 1]
   */
  export let stepValue = 1;

  let focused = false;
  let keyboardFocused = false;
  let isKeyboard = true;

  function testEventDevice(e) {
    if (e.which == 9) {
      isKeyboard = true;
    } else {
      isKeyboard = false;
    }
  }
  function increaseAction(e) {
    if (e.preventDefaulted || readonly || disabled) {
      return;
    }
    if (NP.plus(value, stepValue) <= maxValue) {
      value = parseFloat(NP.plus(value, stepValue).toFixed(1));
    }
  }

  function reduceAction(e) {
    if (e.preventDefaulted || readonly || disabled) {
      return;
    }
    if (NP.minus(value, stepValue) >= minValue) {
      value = parseFloat(NP.minus(value, stepValue).toFixed(1));
    }
  }
  function handleFocusEvent(f) {
    if (f) {
      focused = true;
      if (isKeyboard) {
        keyboardFocused = true;
      }
    } else {
      focused = false;
      keyboardFocused = false;
    }
  }
</script>

<div
  on:keyup={testEventDevice}
  on:mousedown={() => {
    isKeyboard = false;
  }}
  on:focusin={() => handleFocusEvent(true)}
  on:focusout={() => handleFocusEvent(false)}
  class="spectrum-Stepper"
  class:spectrum-Stepper--quiet={isQuiet}
  class:is-keyboardFocused={keyboardFocused}
  class:is-focused={focused}
  class:is-invalid={isInvalid}
  class:is-disabled={disabled}>
  <TextField
    class="spectrum-Stepper-textfield "
    resetType="number"
    inputClass="spectrum-Textfield-input spectrum-Stepper-input {focused && ` focus-ring`}"
    placeholder={value}
    bind:value
    min={minValue}
    max={maxValue}
    step={stepValue}
    {isQuiet}
    {readonly}
    {disabled} />

  <span class="spectrum-Stepper-buttons">
    <button
      class="spectrum-FieldButton {isQuiet ? 'spectrum-FieldButton--quiet' : ''} spectrum-Stepper-stepUp"
      tabindex="-1"
      on:click={increaseAction}
      {disabled}>
      <IconChevronUpSmall className="spectrum-UIIcon-ChevronUpSmall" focusable="false" aria-hidden="true" />
    </button>
    <button
      class="spectrum-FieldButton {isQuiet ? 'spectrum-FieldButton--quiet' : ''} spectrum-Stepper-stepDown"
      tabindex="-1"
      on:click={reduceAction}
      {disabled}>
      <IconChevronDownSmall className="spectrum-UIIcon-ChevronDownSmall" focusable="false" aria-hidden="true" />
    </button>
  </span>
</div>
