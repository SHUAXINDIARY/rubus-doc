<script>
  import { onMount, setContext } from "svelte";

  /**
   * The element css height
   * @type {DimensionValue} [height = "auto"]
   */
  export let height = "auto";

  /**
   * The element css width
   * @type {DimensionValue} [width = 250]
   */
  export let width = 250;

  /**
   * Specify the quiet for the TreeView
   * @type {boolean} [isQuiet = false]
   */
  export let isQuiet = false;

  /**
   * Whether to enable Thumbnail component
   * @type {boolean} [hasThumbnail = false]
   */
  export let hasThumbnail = false;

  /**
   * Whether to enable resource explorer style
   * @type {boolean} [hasThumbnail = false]
   */
  export let resourceExplorer = false;

  setContext("rubusTreeViewConfig", {
    hasThumbnail: hasThumbnail,
    resourceExplorer: resourceExplorer,
  });

  onMount(() => {
    window.addEventListener("click", initTreeView);
  });

  function furthest(el, selector) {
    var lastMatch = null;
    while (el) {
      if (el.matches && el.matches(selector)) {
        lastMatch = el;
      }
      el = el.parentNode;
    }
    return lastMatch;
  }
  function initTreeView(event) {
    var treeviewItem = event.target.closest(".spectrum-TreeView-item");
    if (!treeviewItem) {
      return;
    }

    var isDisabled = treeviewItem.classList.contains("is-disabled");
    if (isDisabled) {
      return;
    }

    var el;

    if ((el = event.target.closest(".spectrum-TreeView-itemIndicator")) !== null) {
      treeviewItem.classList.toggle("is-open");
      event.preventDefault();
    } else if ((el = event.target.closest(".spectrum-TreeView-itemLink")) !== null) {
      if (!(event.shiftKey || event.metaKey)) {
        // Remove other selected items
        let outerTreeview = furthest(el, ".spectrum-TreeView");
        if (outerTreeview) {
          Array.prototype.forEach.call(outerTreeview.querySelectorAll(".spectrum-TreeView-item.is-selected"), function (
            item
          ) {
            if (item != treeviewItem) {
              item.classList.remove("is-selected");

              var thumbnail = item.querySelector(".spectrum-TreeView-itemThumbnail");
              if (thumbnail) {
                thumbnail.classList.remove("is-focused");
              }
            }
          });
        }
      }
      let selected = treeviewItem.classList.toggle("is-selected");

      var thumbnail = treeviewItem.querySelector(".spectrum-TreeView-itemThumbnail");
      if (thumbnail) {
        thumbnail.classList[selected ? "add" : "remove"]("is-focused");
      }
      event.preventDefault();
    }
  }

  $: styleCssText = [
    height && height.toString().indexOf("size") !== -1
      ? `height:var(--spectrum-global-dimension-${height});`
      : height.toString().indexOf("%") !== -1
      ? `height: ${height};`
      : `height: ${height}px;`,
    width && width.toString().indexOf("size") !== -1
      ? `width:var(--spectrum-global-dimension-${width});`
      : width.toString().indexOf("%") !== -1
      ? `width: ${width};`
      : `width: ${width}px;`,
  ]
    .filter(Boolean)
    .join(" ");
</script>

<ul
  class="spectrum-TreeView"
  class:spectrum-TreeView--thumbnail={hasThumbnail}
  class:spectrum-TreeView--quiet={isQuiet}
  style={styleCssText}>
  <slot />
</ul>
