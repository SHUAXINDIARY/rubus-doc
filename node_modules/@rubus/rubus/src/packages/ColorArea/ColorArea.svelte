<script>
  import { onMount, afterUpdate } from "svelte";
  import { throttle } from "throttle-debounce";
  import ColorHandle from "../ColorHandle";
  import Color from "../utils/color/color.js";

  /**
   * Custom size: width
   * @type { number } [width = 192]
   */
  export let width = 192;

  /**
   * Custom size: height
   * @type { number } [height = width]
   */
  export let height = width;

  /**
   * Set to `true` to disable the colorarea
   * @type {boolean}[disabled=false]
   */
  export let disabled = false;

  /**
   * Final color pick result
   * @type {string}[currentColor = "#fff"]
   */
  export let currentColor = "rgb(255,0,0)";

  let px = 0;
  let py = 0;
  let canvas;
  let baseColor = "rgb(255,0,0)";

  $: initColor = Color(currentColor);
  $: hue = initColor.hue();

  function createColorArea(color) {
    let context = canvas.getContext("2d");
    context.rect(0, 0, canvas.width, canvas.height);

    let gradB = context.createLinearGradient(0, 0, 0, canvas.height);
    gradB.addColorStop(0, "white");
    gradB.addColorStop(1, "black");
    let gradC = context.createLinearGradient(0, 0, canvas.width, 0);
    gradC.addColorStop(0, "rgb(255,255,255)");
    gradC.addColorStop(1, color);

    context.fillStyle = gradB;
    context.fillRect(0, 0, canvas.width, canvas.height);
    context.fillStyle = gradC;
    context.globalCompositeOperation = "multiply";
    context.fillRect(0, 0, canvas.width, canvas.height);
    context.globalCompositeOperation = "source-over";
  }

  function colorToPos(color) {
    const thisRect = canvas.getBoundingClientRect();
    let _color = Color(color);
    let hsl = _color.hsl().object();
    let hsv = _color.hsv().object();

    let x = thisRect.width * hsv.s;
    let y = thisRect.height * hsv.v;
    px = (x / 100 / thisRect.width) * 100;
    py = 100 - (y / 100 / thisRect.height) * 100;
  }

  function startGetAreaColor(e) {
    getAreaColor(e);
    window.addEventListener("mousemove", getAreaColor);
    window.addEventListener("mouseup", endGetAreaColor);
  }

  function getAreaColor(e) {
    e.preventDefault();

    const thisRect = canvas.getBoundingClientRect();
    let x = e.pageX - thisRect.left;
    let y = e.pageY - thisRect.top;

    if (x > thisRect.width) {
      x = thisRect.width;
    }
    if (x < 0) {
      x = 0;
    }
    if (y > thisRect.height) {
      y = thisRect.height;
    }
    if (y < 0) {
      y = 0.1;
    }
    let lightness = 0.5;
    let saturation = 1;
    let xRatio = (x / thisRect.width) * 100;
    let yRatio = (y / thisRect.height) * 100;
    let hsvValue = 1 - yRatio / 100;
    let hsvSaturation = xRatio / 100;

    lightness = (hsvValue / 2) * (2 - hsvSaturation);
    saturation = (hsvValue * hsvSaturation) / (1 - Math.abs(2 * lightness - 1));

    const colorStr = `hsl(${hue},${isNaN(parseInt(saturation * 100)) ? 0 : parseInt(saturation * 100)}%,${
      isNaN(parseInt(lightness * 100)) ? 0 : parseInt(lightness * 100)
    }%)`;
    const color = Color.hsl(colorStr);

    px = xRatio;
    py = yRatio;
    currentColor = color.rgb().string();
  }

  function endGetAreaColor() {
    window.removeEventListener("mousemove", getAreaColor);
  }

  onMount(() => {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    canvas.addEventListener("mousedown", function (e) {
      startGetAreaColor(e);
    });
    baseColor = currentColor;
  });

  afterUpdate(() => {
    let staticColor = Color(baseColor);
    let staticHsl = staticColor.hsl().object();

    let varColor = Color(currentColor);
    let varHsl = varColor.hsl().object();

    let finalColor = Color.hsl(`hsl(${varHsl.h}, ${staticHsl.s}%, 50%)`);
    canvas && throttle(500, createColorArea(finalColor.hex()));

    //Prevent automatic positioning when the current color is '#000000'
    if (varHsl.l != 0) {
      canvas && throttle(500, colorToPos(currentColor));
    }
  });
</script>

<style global>
  .spectrum-ColorArea:before {
    display: none;
  }
</style>

<div class="spectrum-ColorArea" class:is-disabled={disabled} style="width: {width}px; height: {height}px">
  <canvas class="spectrum-ColorArea-gradient" bind:this={canvas} />
  <ColorHandle class="spectrum-ColorArea-handle" {px} {py} color={currentColor} {disabled} />

  <input
    type="range"
    class="spectrum-ColorArea-slider"
    name="x"
    aria-label="saturation and value"
    aria-disabled={disabled}
    min="0"
    max="1"
    step={px / 100}
    {disabled} />
  <input
    type="range"
    class="spectrum-ColorArea-slider"
    name="y"
    aria-label="saturation and value"
    aria-disabled={disabled}
    min="0"
    max="1"
    step={py / 100}
    {disabled} />
</div>
