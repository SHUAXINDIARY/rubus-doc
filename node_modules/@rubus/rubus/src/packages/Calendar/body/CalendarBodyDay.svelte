<script>
  import { beforeUpdate, getContext } from "svelte";
  import { formatDatetamp, theDayOfTheWeek } from "../calendar.js";
  import noun from "../i18n";

  export let day = 1;

  export let isSelected = false;

  export let isFocused = false;

  export let invalid = false;

  export let disabled = false;

  let isRangeSelection = false;

  let isSelectionStart = false;

  let isSelectionEnd = false;

  let isRangeStart = false;

  let isRangeEnd = false;

  let rubusCalendar = getContext("RubusCalendarData");

  $: dayLabel = new Date(day).getDate();
  $: isWeekend = theDayOfTheWeek(day) === 6 || theDayOfTheWeek(day) === 7;
  $: isOutsideMonth = new Date($rubusCalendar.viewDate).getMonth() != new Date(day).getMonth();

  $: isToday =
    new Date($rubusCalendar.nowDate).getDate() == new Date(day).getDate() &&
    new Date($rubusCalendar.nowDate).getMonth() == new Date(day).getMonth() &&
    new Date($rubusCalendar.nowDate).getFullYear() == new Date(day).getFullYear();

  beforeUpdate(() => {
    if ($rubusCalendar.pickerMode == "single") {
      isSelected = new Date(day).getTime() == new Date($rubusCalendar.selected).getTime();
    }
    if ($rubusCalendar.pickerMode == "range") {
      [isRangeSelection, isSelectionStart, isSelectionEnd] = testSelectedRange(day);
      isRangeStart = theDayOfTheWeek(day) == 1;
      isRangeEnd = theDayOfTheWeek(day) == 7;
      isSelected = isRangeSelection;
    }
  });

  function formarWeekName(n) {
    let dotw = theDayOfTheWeek(n);
    return noun[$rubusCalendar.lang][`weekFullName`][dotw - 1];
  }

  function pick() {
    if ($rubusCalendar.pickerMode == "single") {
      $rubusCalendar.selected = new Date(day).getTime();
    }
    if ($rubusCalendar.pickerMode == "range") {
      $rubusCalendar.selected = rangePicker($rubusCalendar.selected);
    }
  }

  function testSelectedRange(n) {
    let i = new Date(n).getTime();
    let startDate = new Date($rubusCalendar.selected[0]).getTime();
    let endDate = new Date($rubusCalendar.selected[1]).getTime();
    return [i >= startDate && i <= endDate, i == startDate, i == endDate];
  }

  function rangePicker(arr) {
    let thisDate = new Date(day).getTime();
    let startDate = new Date(arr[0]).getTime();
    let endDate = new Date(arr[1]).getTime();

    if (!endDate || !startDate || startDate == thisDate) {
      startDate = thisDate;
      endDate = thisDate;
    } else {
      if (thisDate > endDate) {
        endDate = thisDate;
      } else if (thisDate < startDate || thisDate > startDate) {
        startDate = thisDate;
      } else if (thisDate == endDate) {
        startDate = thisDate;
      }
    }

    return [startDate, endDate];
  }
</script>

<style>
  .rubus-calendar-weekend {
    background-color: var(--spectrum-alias-border-color-light);
  }

  .rubus-calendar-outsideMonth {
    color: var(--spectrum-alias-placeholder-text-color);
  }
  .rubus-calendar-outsideMonth-disabled {
    color: var(--spectrum-global-color-gray-300);
  }
</style>

<td
  role="gridcell"
  class="spectrum-Calendar-tableCell"
  class:rubus-calendar-weekend={isWeekend}
  aria-disabled={disabled || invalid}
  aria-selected={isSelected || $rubusCalendar.result === +day}
  aria-invalid={invalid}
  title={formarWeekName(day) + ' , ' + formatDatetamp(day, 'yyyy-mm-dd')}>
  <span
    role="presentation"
    on:click={pick}
    class="spectrum-Calendar-date"
    class:is-today={isToday}
    class:is-selected={isSelected || $rubusCalendar.result === +day}
    class:is-focused={isFocused}
    class:is-disabled={disabled || invalid}
    class:is-range-selection={isRangeSelection}
    class:is-selection-start={isSelectionStart}
    class:is-selection-end={isSelectionEnd}
    class:is-range-start={isRangeStart}
    class:is-range-end={isRangeEnd}
    class:rubus-calendar-outsideMonth={isOutsideMonth}
    class:rubus-calendar-outsideMonth-disabled={isOutsideMonth && (disabled || invalid)}
    class:is-outsideMonth={isOutsideMonth && !$rubusCalendar.showOutsideMonth}>{dayLabel}</span>
</td>
