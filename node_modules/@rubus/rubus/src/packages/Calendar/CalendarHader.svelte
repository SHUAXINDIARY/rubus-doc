<script>
  import { onMount, getContext } from "svelte";
  import { IconChevronLeftMedium, IconChevronRightMedium } from "@rubus/svelte-spectrum-icons-ui";
  import Button from "../Button";
  import { ButtonIconWrap } from "../ButtonGroup";
  import { getPrevYearAndMonth, getNextYearAndMonth } from "./calendar.js";
  import noun from "./i18n";

  let m;
  let y;
  let rubusCalendar = getContext("RubusCalendarData");
  $: yearAndMonth = formatMonthName($rubusCalendar.viewDate);

  onMount(() => {
    m = new Date().getMonth() + 1;
    y = new Date().getFullYear();
  });

  function formatMonthName(n) {
    let nd = new Date(n);
    let ty = nd.getFullYear();
    let tm = nd.getMonth();

    let monthName = noun[$rubusCalendar.lang][$rubusCalendar.monthName][tm];
    let calendarTitle;
    switch ($rubusCalendar.view) {
      case "month":
        calendarTitle = `${monthName} - ${ty}`;
        break;
      case "year":
        calendarTitle = `${ty}`;
        break;
    }

    return calendarTitle;
  }
  function prev() {
    let nd = new Date($rubusCalendar.viewDate);
    let ty = nd.getFullYear();
    let tm = nd.getMonth() + 1;
    let td = nd.getDate();
    let [py, pm] = getPrevYearAndMonth(ty, tm);
    switch ($rubusCalendar.view) {
      case "month":
        $rubusCalendar.viewDate = `${py}-${pm}-${td}`;
        break;
      case "year":
        $rubusCalendar.viewDate = `${ty - 1}-${tm}-${td}`;
        break;
    }

    $rubusCalendar.action = "prev";
    $rubusCalendar.flag = !$rubusCalendar.flag;
  }
  function next() {
    let nd = new Date($rubusCalendar.viewDate);
    let ty = nd.getFullYear();
    let tm = nd.getMonth() + 1;
    let td = nd.getDate();
    let [ny, nm] = getNextYearAndMonth(ty, tm);
    switch ($rubusCalendar.view) {
      case "month":
        $rubusCalendar.viewDate = `${ny}-${nm}-${td}`;
        break;
      case "year":
        $rubusCalendar.viewDate = `${ty + 1}-${tm}-${td}`;
        break;
    }
    $rubusCalendar.action = "next";
    $rubusCalendar.flag = !$rubusCalendar.flag;
  }
  function switchView() {
    switch ($rubusCalendar.view) {
      case "month":
        $rubusCalendar.view = "year";
        break;
      case "year":
        $rubusCalendar.view = "month";
        break;
    }
  }
</script>

<div class="spectrum-Calendar-header">
  <Button
    on:click={switchView}
    exterior="action"
    isQuiet
    class="spectrum-Calendar-title"
    role="heading"
    aria-live="assertive"
    aria-atomic="true">
    {yearAndMonth}
  </Button>

  <Button exterior="action" isQuiet ariaLabel="Prev" class="spectrum-Calendar-prevMonth" on:click={prev}>
    <ButtonIconWrap onlyIcon>
      <IconChevronLeftMedium focusable="false" aria-hidden="true" />
    </ButtonIconWrap>
  </Button>
  <Button exterior="action" isQuiet ariaLabel="Next" class="spectrum-Calendar-nextMonth" on:click={next}>
    <ButtonIconWrap onlyIcon>
      <IconChevronRightMedium focusable="false" aria-hidden="true" />
    </ButtonIconWrap>
  </Button>
</div>
