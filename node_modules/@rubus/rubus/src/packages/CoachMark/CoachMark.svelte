<script>
  import { onMount, afterUpdate } from "svelte";
  import Image from "../Asset/Image.svelte";
  import { setPositionedAccording, advanceAddClassName } from "../utils/presetStyle.js";
  import { integrateAutoProps } from "../utils/integrate-style-props.js";

  /**
   * Set an quiet mode for the coach mark
   * @type {boolean} [indeterminate = false]
   */
  export let isQuiet = false;

  /**
   * Specify the variants of coach mark
   * @type { "general" | "light" | "dark" } [variants = "general"
   */
  export let variants = "general";

  /**
   * Set the alt attribute of the  cover photo url
   * @type {string} [coverPhotoAlt = "Cover photo"]
   */
  export let coverPhotoAlt = "Cover photo";

  /**
   * Set the src attribute of the cover photo url
   * @type {string} [coverPhotoUrl = ""]
   */
  export let coverPhotoUrl = "";

  /**
   * Set the src coachMarkPopover title
   * @type {string} [title = ""]
   */
  export let title = "";

  /**
   * Set the total steps text
   * @type {number} [totalStep = 0]
   */
  export let totalStep = 0;

  /**
   * Set the present steps text
   * @type {number} [presentStep = 1]
   */
  export let presentStep = 1;

  /**
   * Set the position of coachMarkPopover
   * @type {"leftTop"|"leftBottom"|"rightTop"|"rightBottom"} [coachMarkPopoverPosition = "leftTop"]
   */
  export let coachMarkPopoverPosition = "leftTop";

  /**
   * Overrides the positioning related style.
   * @type { IPosition } [positioning = {}]
   */
  export let positioning = {};

  let coachMarkIndicator;
  let coachMarkPopover;
  let positioningCssText = "";
  onMount(() => {
    coachMarkPopover &&
      advanceAddClassName(coachMarkPopover, "coachmark-popover-footer", "spectrum-CoachMarkPopover-footer");
    coachMarkIndicator && setPositionedAccording(coachMarkIndicator);
  });
  afterUpdate(() => {
    positioningCssText = integrateAutoProps(positioning);
  });
</script>

<style global>
  .spectrum-CoachMarkIndicator {
    position: absolute;
    margin: 0;
    padding: 0;
    z-index: 100;
  }
  .rubus-CoachMarkPopover {
    position: relative;
  }
  .spectrum-CoachMarkPopover {
    position: absolute;
    z-index: 100;
  }
  [dir="ltr"] .rubus-CoachMarkPopover-leftTop {
    left: var(--spectrum-global-dimension-size-700);
  }
  [dir="rtl"] .rubus-CoachMarkPopover-leftTop {
    right: var(--spectrum-global-dimension-size-700);
  }
  [dir="ltr"] .rubus-CoachMarkPopover-rightTop {
    right: var(--spectrum-global-dimension-size-700);
  }
  [dir="rtl"] .rubus-CoachMarkPopover-rightTop {
    left: var(--spectrum-global-dimension-size-700);
  }
  [dir="ltr"] .rubus-CoachMarkPopover-leftBottom {
    left: var(--spectrum-global-dimension-size-700);
    bottom: calc(-1 * var(--spectrum-global-dimension-size-500));
  }
  [dir="rtl"] .rubus-CoachMarkPopover-leftBottom {
    right: var(--spectrum-global-dimension-size-700);
    bottom: calc(-1 * var(--spectrum-global-dimension-size-500));
  }
  [dir="ltr"] .rubus-CoachMarkPopover-rightBottom {
    right: var(--spectrum-global-dimension-size-700);
    bottom: calc(-1 * var(--spectrum-global-dimension-size-500));
  }
  [dir="rtl"] .rubus-CoachMarkPopover-rightBottom {
    left: var(--spectrum-global-dimension-size-700);
    bottom: calc(-1 * var(--spectrum-global-dimension-size-500));
  }
  [dir="ltr"] .rubus-CoachMarkPopover-quiet-leftTop {
    left: var(--spectrum-global-dimension-size-500);
  }
  [dir="rtl"] .rubus-CoachMarkPopover-quiet-leftTop {
    right: var(--spectrum-global-dimension-size-500);
  }
  [dir="ltr"] .rubus-CoachMarkPopover-quiet-rightTop {
    right: var(--spectrum-global-dimension-size-500);
  }
  [dir="rtl"] .rubus-CoachMarkPopover-quiet-rightTop {
    left: var(--spectrum-global-dimension-size-500);
  }
  [dir="ltr"] .rubus-CoachMarkPopover-quiet-leftBottom {
    left: var(--spectrum-global-dimension-size-500);
    bottom: calc(-1 * var(--spectrum-global-dimension-size-250));
  }
  [dir="rtl"] .rubus-CoachMarkPopover-quiet-leftBottom {
    right: var(--spectrum-global-dimension-size-500);
    bottom: calc(-1 * var(--spectrum-global-dimension-size-250));
  }
  [dir="ltr"] .rubus-CoachMarkPopover-quiet-rightBottom {
    right: var(--spectrum-global-dimension-size-500);
    bottom: calc(-1 * var(--spectrum-global-dimension-size-250));
  }
  [dir="rtl"] .rubus-CoachMarkPopover-quiet-rightBottom {
    left: var(--spectrum-global-dimension-size-500);
    bottom: calc(-1 * var(--spectrum-global-dimension-size-250));
  }
</style>

<div
  bind:this={coachMarkIndicator}
  class="spectrum-CoachMarkIndicator"
  class:spectrum-CoachMarkIndicator--quiet={isQuiet}
  class:spectrum-CoachMarkIndicator--dark={variants == 'dark'}
  class:spectrum-CoachMarkIndicator--light={variants == 'light'}
  style={positioningCssText}>
  <div class="rubus-CoachMarkPopover">
    <div
      class="spectrum-CoachMarkPopover {isQuiet ? `rubus-CoachMarkPopover-quiet-${coachMarkPopoverPosition}` : `rubus-CoachMarkPopover-${coachMarkPopoverPosition}`}"
      bind:this={coachMarkPopover}>
      {#if coverPhotoUrl}
        <Image imgUrl={coverPhotoUrl} imgAlt={coverPhotoAlt} class="spectrum-CoachMarkPopover-image" />
      {/if}
      <div class="spectrum-CoachMarkPopover-header">
        <div class="spectrum-CoachMarkPopover-title">{title}</div>
        {#if totalStep}
          <div class="spectrum-CoachMarkPopover-step"><bdo dir="ltr">{presentStep} of {totalStep}</bdo></div>
        {/if}
      </div>
      <div class="spectrum-CoachMarkPopover-content">
        <slot />
      </div>
      <slot name="coachmark-popover-footer" />
    </div>
  </div>
  <div class="spectrum-CoachMarkIndicator-ring" />
  <div class="spectrum-CoachMarkIndicator-ring" />
  <div class="spectrum-CoachMarkIndicator-ring" />
</div>
