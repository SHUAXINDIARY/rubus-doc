<script>
  import ResizeObserver from "resize-observer-polyfill";
  import { throttle } from "throttle-debounce";
  import { afterUpdate, onDestroy } from "svelte";

  /**
   * Specify the orientation  for the tabs
   * @type {"horizontal" | "vertical"}  [orientation = "horizontal"]
   */
  export let orientation = "horizontal";

  /**
   * Specify the aria-label
   * @type {string} [aria-label="tabList"]
   */
  export let ariaLabel = "tabList";

  /**
   * Specify the quiet mode of tab
   * @type { boolean }   [isQuiet= false]
   */
  export let isQuiet = false;

  /**
   * Specify the compact mode of tab
   * Compact tabs should never be used without the quiet variation. Please use Quiet Compact Tabs instead.
   * @type { boolean }   [isQuiet= false]
   */
  export let isCompact = false;

  let selectedItemDimension;
  let tabs;
  let selectionIndicatorOffset;

  const observer = new ResizeObserver(getStyleAttributeValue);

  afterUpdate(() => {
    getStyleAttributeValue();
    throttle(500, observer.observe(tabs));
  });

  onDestroy(() => {
    observer.unobserve(tabs);
  });

  function getPosition(e) {
    if (tabs.contains(e.target) && e.target.className.indexOf("spectrum-Tabs-item") != -1) {
      selectedItemDimension = e.target.offsetWidth;
      selectionIndicatorOffset = e.target.offsetLeft;
    }
  }

  function getStyleAttributeValue() {
    if (tabs) {
      const selectedItem = tabs.getElementsByClassName("is-selected");
      if (selectedItem.length == 1) {
        if (orientation == "horizontal") {
          selectedItemDimension = selectedItem[0].offsetWidth;
          selectionIndicatorOffset = selectedItem[0].offsetLeft;
        } else if (orientation == "vertical") {
          selectedItemDimension = selectedItem[0].offsetHeight;
          selectionIndicatorOffset = selectedItem[0].offsetTop;
        }
      }
    }
  }

  function handleKeydown(e) {
    let _e = event ? window.event : e;
    if (_e.keyCode == 13 || _e.keyCode == 32) {
      getPosition(e);
    }
  }

  $: tabsProps = {
    role: "tabList",
    class: [
      "spectrum-Tabs",
      orientation && `spectrum-Tabs--${orientation}`,
      isQuiet && "spectrum-Tabs--quiet",
      isCompact && "spectrum-Tabs--compact",
    ]
      .filter(Boolean)
      .join(" "),
  };

  $: selectionIndicatorSytle = [
    orientation === "vertical" && `height: ${selectedItemDimension}px;`,
    orientation === "horizontal" && `width: ${selectedItemDimension}px;`,
    orientation === "vertical" && `transform:translateY(${selectionIndicatorOffset}px);`,
    orientation === "horizontal" &&
      `transform:translateX(${
        !selectionIndicatorOffset
          ? "var(--spectrum-tabs-focus-ring-padding-x, var(--spectrum-global-dimension-size-100)"
          : selectionIndicatorOffset + "px"
      });`,
  ]
    .filter(Boolean)
    .join(" ");
</script>

<div
  {...tabsProps}
  {...$$restProps}
  aria-label={ariaLabel}
  aria-orientation={orientation}
  bind:this={tabs}
  on:resize={getStyleAttributeValue}
  on:click={getPosition}
  on:keydown={handleKeydown}>
  <slot />
  <div class="spectrum-Tabs-selectionIndicator" style={selectionIndicatorSytle} />
</div>
