<script>
  import { afterUpdate, beforeUpdate, onMount } from "svelte";
  import ColorHandle from "../ColorHandle";
  import Color from "../utils/color/color.js";

  // TODO

  /**
   * Final color pick result
   * @type {string}[currentColor = "#fff"]
   */
  export let currentColor = "rgb(255,0,0)";

  let px = 0;
  let py = 0;

  let canvas;
  $: initColor = Color(currentColor);
  $: hue = initColor.hue();

  function createColorWheel() {
    let context = canvas.getContext("2d");
    context.rect(0, 0, canvas.width, canvas.height);

    let width = canvas.width;
    let height = canvas.height;
    let centerX = width / 2;
    let centerY = height / 2;
    let ringSize = 57;

    for (let i = 0; i < 360; i += Math.PI / 8) {
      let rad = (i * (2 * Math.PI)) / 360;
      context.strokeStyle = `hsla(${i}, 100%, 50%, 1.0)`;
      context.beginPath();
      context.moveTo(centerX + ringSize * Math.cos(rad), centerY + ringSize * Math.sin(rad));
      context.lineTo(centerX + centerX * Math.cos(rad), centerY + centerY * Math.sin(rad));
      context.stroke();
    }
  }

  function startGetWheelColor(e) {
    getWheelColor(e);
    window.addEventListener("mousemove", getWheelColor);
    window.addEventListener("mouseup", endGetWheelColor);
  }
  function getWheelColor(e) {
    e.preventDefault();

    const thisRect = canvas.getBoundingClientRect();
    let x = e.pageX - thisRect.left;
    let y = e.pageY - thisRect.top;

    if (x > thisRect.width) {
      x = thisRect.width;
    }
    if (x < 0) {
      x = 0;
    }
    if (y > thisRect.height) {
      y = thisRect.height;
    }
    if (y < 0) {
      y = 0.1;
    }
    let lightness = 0.5;
    let saturation = 1;
    let xRatio = (x / thisRect.width) * 100;
    let yRatio = (y / thisRect.height) * 100;
    let hsvValue = 1 - yRatio / 100;
    let hsvSaturation = xRatio / 100;

    lightness = (hsvValue / 2) * (2 - hsvSaturation);
    saturation = (hsvValue * hsvSaturation) / (1 - Math.abs(2 * lightness - 1));
    px = xRatio;
    py = yRatio;
    let ctx = canvas.getContext("2d");
    let data = ctx.getImageData(x, y, 1, 1);

    currentColor = `rgb(${data.data[0]},${data.data[1]},${data.data[2]})`;

    // const colorStr = `hsl(${hue},${isNaN(parseInt(saturation * 100)) ? 0 : parseInt(saturation * 100)}%,${
    //   isNaN(parseInt(lightness * 100)) ? 0 : parseInt(lightness * 100)
    // }%)`;
    // const color = Color.hsl(colorStr);

    // currentColor = color.rgb().string();
  }

  function endGetWheelColor() {
    window.removeEventListener("mousemove", getWheelColor);
  }

  onMount(() => {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    createColorWheel();
    canvas.addEventListener("mousedown", function (e) {
      startGetWheelColor(e);
    });
  });
</script>

<div class="spectrum-ColorWheel">
  <canvas class="spectrum-ColorWheel-gradient" bind:this={canvas} />
  <ColorHandle class="spectrum-ColorWheel-handle" {px} {py} color={currentColor} />

  <input type="range" class="spectrum-ColorWheel-slider" aria-label="hue" min="0" max="360" step="`" />
</div>
