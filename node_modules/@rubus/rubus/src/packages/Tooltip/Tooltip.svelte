<script>
  import { IconInfoMedium, IconAlertMedium, IconSuccessMedium, IconHelpSmall } from "@rubus/svelte-spectrum-icons-ui";
  import { afterUpdate, onMount } from "svelte";

  /**
   *  Specify the label text for the tooltip
   * @type {string} [label = ""]
   */
  export let label = "";

  /**
   * Specify the variants  for the  tooltip
   * @type {"default" | "info" | "negative" | "positive" | "help" } [variants = "default"]
   */
  export let variants = "default";

  /**
   *  Specify the open status for the tooltip
   * @type {string} [label = ""]
   */
  export let isOpen = false;

  /**
   * Specify the directions  for the  tooltip
   * @type {"top" | "bottom" | "left" | "right" } [directions = "top"]
   */
  export let directions = "top";

  /**
   *  Set the trigger event name to open the tooltip
   * @type {"mouseover" | "mouseenter" | "click" | "contextmenu" | "dblclick" | "mousedown" | "mouseup" | "select" | "keydown" | "keypress" | "keyup"} [induceStartEventName = "mouseover"]
   */
  export let induceStartEventName = "mouseover";

  /**
   * Set the trigger event name to close the tooltip
   * @type {"mouseout" | "mouseleave" | "click" | "contextmenu" | "dblclick" | "mousedown" | "mouseup" | "select" | "keydown" | "keypress" | "keyup"} [induceEndEventName = "mouseout"]
   */
  export let induceEndEventName = "mouseout";

  /**
   * The element css width
   * @type {DimensionValue} [width = "size-2000"]
   */
  export let width = "size-2000";

  let tooltipEl;
  let styleText = "";
  let tooltipCH;

  onMount(() => {
    if (tooltipEl) {
      tooltipEl.parentNode.classList.toggle("u-tooltip-showOnEvent");

      tooltipEl.parentNode.addEventListener(induceStartEventName, function () {
        isOpen = !isOpen;
      });
      if (induceStartEventName !== induceEndEventName) {
        tooltipEl.parentNode.addEventListener(induceEndEventName, function () {
          if (isOpen) isOpen = false;
        });
      }
    }
  });

  afterUpdate(() => {
    let tooltipWrapHeight = tooltipEl.parentNode.clientHeight;
    let tooltipWrapWidth = tooltipEl.parentNode.clientWidth;
    let widthCss =
      width && width.toString().indexOf("size") !== -1
        ? `width:var(--spectrum-global-dimension-${width});`
        : width.toString().indexOf("%") !== -1
        ? `width: ${width};`
        : `width: ${width}px;`;

    switch (directions) {
      case "top":
        styleText = `top:-${tooltipCH + tooltipWrapHeight * 0.5}px;${widthCss}`;
        break;
      case "bottom":
        styleText = `top:calc(var(--spectrum-global-dimension-size-75) + ${tooltipWrapHeight}px);${widthCss}`;
        break;
      case "left":
        styleText = `left:calc(-1 * var(--spectrum-global-dimension-size-75));${widthCss}`;
        break;
      case "right":
        styleText = `left:calc(var(--spectrum-global-dimension-size-75) + ${tooltipWrapWidth}px);${widthCss}`;
        break;
    }
  });
</script>

<style global>
  .u-tooltip-showOnEvent {
    display: inline-block;
    position: relative;
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip {
    position: absolute;
    white-space: nowrap;
    visibility: visible !important;
    transition: transform var(--spectrum-global-animation-duration-100, 130ms) ease-in-out;
    top: -100%;
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip-label {
    max-width: none;
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip--right,
  .u-tooltip-showOnEvent .spectrum-Tooltip--left {
    top: 50%;
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip--right .spectrum-Tooltip-tip,
  .u-tooltip-showOnEvent .spectrum-Tooltip--left .spectrum-Tooltip-tip {
    top: 50%;
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip--right {
    left: 100%;
    transform: translate(0, -50%);
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip--left {
    transform: translate(-100%, -50%);
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip--bottom,
  .u-tooltip-showOnEvent .spectrum-Tooltip--top {
    left: 50%;
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip--bottom .spectrum-Tooltip-tip,
  .u-tooltip-showOnEvent .spectrum-Tooltip--top .spectrum-Tooltip-tip {
    left: 50%;
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip--bottom {
    top: 100%;
    transform: translate(-50%, calc(-1 * var(--spectrum-tooltip-tip-margin, var(--spectrum-global-dimension-size-50))));
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip--top {
    transform: translate(-50%, var(--spectrum-tooltip-tip-margin, var(--spectrum-global-dimension-size-50)));
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip.is-open,
  .u-tooltip-showOnEvent:focus .spectrum-Tooltip,
  .u-tooltip-showOnEvent.is-focused .spectrum-Tooltip,
  .u-tooltip-showOnEvent *:focus .spectrum-Tooltip {
    opacity: 1;
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip.is-open.spectrum-Tooltip--bottom,
  .u-tooltip-showOnEvent:focus .spectrum-Tooltip.spectrum-Tooltip--bottom,
  .u-tooltip-showOnEvent.is-focused .spectrum-Tooltip.spectrum-Tooltip--bottom,
  .u-tooltip-showOnEvent *:focus .spectrum-Tooltip.spectrum-Tooltip--bottom {
    transform: translate(-50%, 0);
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip.is-open.spectrum-Tooltip--top,
  .u-tooltip-showOnEvent:focus .spectrum-Tooltip.spectrum-Tooltip--top,
  .u-tooltip-showOnEvent.is-focused .spectrum-Tooltip.spectrum-Tooltip--top,
  .u-tooltip-showOnEvent *:focus .spectrum-Tooltip.spectrum-Tooltip--top {
    transform: translate(-50%, calc(-1 * var(--spectrum-tooltip-tip-margin, var(--spectrum-global-dimension-size-50))));
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip.is-open.spectrum-Tooltip--left,
  .u-tooltip-showOnEvent:focus .spectrum-Tooltip.spectrum-Tooltip--left,
  .u-tooltip-showOnEvent.is-focused .spectrum-Tooltip.spectrum-Tooltip--left,
  .u-tooltip-showOnEvent *:focus .spectrum-Tooltip.spectrum-Tooltip--left {
    transform: translate(
      calc(-100% - var(--spectrum-tooltip-tip-margin, var(--spectrum-global-dimension-size-50))),
      -50%
    );
  }

  .u-tooltip-showOnEvent .spectrum-Tooltip.is-open.spectrum-Tooltip--right,
  .u-tooltip-showOnEvent:focus .spectrum-Tooltip.spectrum-Tooltip--right,
  .u-tooltip-showOnEvent.is-focused .spectrum-Tooltip.spectrum-Tooltip--right,
  .u-tooltip-showOnEvent *:focus .spectrum-Tooltip.spectrum-Tooltip--right {
    transform: translate(var(--spectrum-tooltip-tip-margin, var(--spectrum-global-dimension-size-50)), -50%);
  }

  .spectrum-Tooltip-typeIcon {
    width: var(--spectrum-global-dimension-size-225);
    height: var(--spectrum-global-dimension-size-225);
    transform: scale(0.8);
  }
  .spectrum-Tooltip--help > .spectrum-Tooltip-typeIcon-help {
    transform: scale(1);
  }
  .spectrum-Tooltip-label {
    white-space: normal;
  }
</style>

<span
  class="spectrum-Tooltip spectrum-Tooltip--{variants} spectrum-Tooltip--{directions} "
  style={styleText}
  class:is-open={isOpen}
  bind:clientHeight={tooltipCH}
  bind:this={tooltipEl}>
  {#if variants === 'negative'}
    <IconAlertMedium className="spectrum-Tooltip-typeIcon" focusable="false" aria-hidden="true" />
  {:else if variants === 'info'}
    <IconInfoMedium className="spectrum-Tooltip-typeIcon" focusable="false" aria-hidden="true" />
  {:else if variants === 'positive'}
    <IconSuccessMedium className="spectrum-Tooltip-typeIcon" focusable="false" aria-hidden="true" />
  {:else if variants === 'help'}
    <IconHelpSmall
      className="spectrum-Tooltip-typeIcon spectrum-Tooltip-typeIcon-help"
      focusable="false"
      aria-hidden="true" />
  {/if}
  <span class="spectrum-Tooltip-label"><slot>{label}</slot></span>
  <span class="spectrum-Tooltip-tip" />
</span>
